import path from 'path';
import { writeFileSafely } from './writeFileSafely';

const indexExports = new Set<string>();

export const addIndexExport = (filePath: string) => {
  indexExports.add(filePath);
};

function normalizePath(path: string) {
  if (typeof path !== 'string') {
    throw new TypeError('Expected argument path to be a string');
  }
  if (path === '\\' || path === '/') return '/';

  const len = path.length;
  if (len <= 1) return path;
  let prefix = '';
  if (len > 4 && path[3] === '\\') {
    const ch = path[2];
    if ((ch === '?' || ch === '.') && path.slice(0, 2) === '\\\\') {
      path = path.slice(2);
      prefix = '//';
    }
  }

  const segs = path.split(/[/\\]+/);
  return prefix + segs.join('/');
}

export const writeIndexFile = async (indexPath: string, importExtension: string = '') => {
  const rows = Array.from(indexExports).map((filePath) => {
    let relativePath = path.relative(path.dirname(indexPath), filePath);
    if (relativePath.endsWith('.ts')) {
      relativePath = relativePath.slice(0, relativePath.lastIndexOf('.ts'));
    }
    const normalized = normalizePath(relativePath);
    return `export * from './${normalized}${importExtension}'`;
  });
  // Additionally, ensure directory-level exports for common folders if their index.ts was not added explicitly
  const dirExports: string[] = [];
  const baseDir = path.dirname(indexPath);
  for (const dir of ['enums', 'objects', 'models']) {
    const dirIndex = path.join(baseDir, dir, 'index.ts');
    // If an index.ts exists, ensure it's exported
    try {
      const fs = await import('fs');
      if (fs.existsSync(dirIndex)) {
        const rel = normalizePath(path.relative(baseDir, dirIndex).replace(/\.ts$/, ''));
        const line = `export * from './${rel}${importExtension}'`;
        if (!rows.includes(line)) dirExports.push(line);
      }
    } catch {
      // ignore
    }
  }
  // If variants/index.ts exists under schemas, ensure it's exported as well
  try {
    const fs = await import('fs');
    const variantsIndex = path.join(baseDir, 'variants', 'index.ts');
    if (fs.existsSync(variantsIndex)) {
      const rel = normalizePath(path.relative(baseDir, variantsIndex).replace(/\.ts$/, ''));
      const line = `export * from './${rel}${importExtension}'`;
      if (!rows.includes(line) && !dirExports.includes(line)) dirExports.push(line);
    }
  } catch {
    // ignore
  }
  const content = [...rows, ...dirExports].join('\n');
  await writeFileSafely(indexPath, content, false);
};
